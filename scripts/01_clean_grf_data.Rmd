---
title: "GRF Shooting Data Cleaning"
author: "Samuel Montalvo"
date: "`r Sys.Date()`"
output:
  html_document:
    toc: true
    toc_float: true
    code_folding: show
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo = TRUE,
  message = FALSE,
  warning = FALSE
)
```

## Overview

This script cleans and standardizes the basketball shooting GRF dataset, propagates player-level covariates across repeated trials, and saves a cleaned CSV file.

## Load Packages

```{r load-packages}
library(tidyverse)
library(janitor)
library(here)
```

## 1. Read the CSV Data

```{r read-data}
# Determine repo root
repo_root <- here::here()

# Input file path
input_file <- file.path(repo_root, "data", "GRF Shooting SM[40].csv")

# Check if file exists
if (!file.exists(input_file)) {
  stop("Input file not found: ", input_file)
}

cat("Reading data from:", input_file, "\n")

# Read the raw data
raw_data <- read_csv(input_file, show_col_types = FALSE)

cat("Raw data dimensions:", nrow(raw_data), "rows x", ncol(raw_data), "cols\n")
```

## 2. Clean Column Names

```{r clean-names}
df <- raw_data %>%
  janitor::clean_names()

cat("Cleaned column names:\n")
cat(paste(names(df), collapse = "\n"))
```

## 3. Detect and Map Key Columns

```{r detect-columns}
col_names <- names(df)

# Function to find columns by keyword patterns
find_column <- function(cols, patterns, exclude_patterns = NULL) {
  matches <- character(0)
  for (p in patterns) {
    found <- cols[str_detect(tolower(cols), tolower(p))]
    if (!is.null(exclude_patterns)) {
      for (ep in exclude_patterns) {
        found <- found[!str_detect(tolower(found), tolower(ep))]
      }
    }
    matches <- c(matches, found)
  }
  unique(matches)
}

# Detect player_id column
player_id_candidates <- find_column(col_names, c("subject", "player", "pid", "athlete", "^id$"))
player_id_col <- if (length(player_id_candidates) > 0) player_id_candidates[1] else NA

# Detect shot_type column
shot_type_candidates <- find_column(col_names, c("shot_type", "shot.*type", "type.*2.*3", "2.*3"))
shot_type_col <- if (length(shot_type_candidates) > 0) shot_type_candidates[1] else NA

# Detect made/result column
made_candidates <- find_column(col_names, c("made", "miss", "result", "outcome", "make"))
made_col <- if (length(made_candidates) > 0) made_candidates[1] else NA

# Print column mapping
cat("========================================\n")
cat("COLUMN MAPPING\n")
cat("========================================\n")
cat("player_id mapped to:", ifelse(is.na(player_id_col), "NOT FOUND", player_id_col), "\n")
cat("shot_type mapped to:", ifelse(is.na(shot_type_col), "NOT FOUND", shot_type_col), "\n")
cat("made mapped to:     ", ifelse(is.na(made_col), "NOT FOUND", made_col), "\n")
```

## 4. Standardize Key Columns

```{r standardize-columns}
# Rename and convert player_id
if (!is.na(player_id_col)) {
  df <- df %>%
    rename(player_id = !!sym(player_id_col)) %>%
    mutate(player_id = as.character(player_id))
}

# Rename and convert shot_type to factor
if (!is.na(shot_type_col) && shot_type_col != "player_id") {
  df <- df %>%
    rename(shot_type = !!sym(shot_type_col)) %>%
    mutate(
      shot_type = case_when(
        shot_type %in% c(2, "2", "2PT", "2pt") ~ "2PT",
        shot_type %in% c(3, "3", "3PT", "3pt") ~ "3PT",
        TRUE ~ as.character(shot_type)
      ),
      shot_type = factor(shot_type, levels = c("2PT", "3PT"))
    )
}

# Rename and convert made to 0/1
if (!is.na(made_col) && made_col != "player_id" && made_col != "shot_type") {
  df <- df %>%
    rename(made = !!sym(made_col)) %>%
    mutate(made = as.integer(made))
}
```

## 5. Parse Numeric Columns

```{r parse-numeric}
# Function to clean numeric values
clean_numeric <- function(x) {
  if (is.numeric(x)) return(x)
  x_clean <- str_remove_all(as.character(x), "[,%$]")
  x_clean <- str_trim(x_clean)
  as.numeric(x_clean)
}

# Identify columns that should be numeric
skip_cols <- c("player_id", "shot_type", "made", "position")
numeric_candidates <- setdiff(names(df), skip_cols)

for (col in numeric_candidates) {
  if (!is.numeric(df[[col]])) {
    test_numeric <- suppressWarnings(clean_numeric(df[[col]]))
    non_na_ratio <- sum(!is.na(test_numeric)) / sum(!is.na(df[[col]]))
    if (non_na_ratio > 0.8) {
      df[[col]] <- test_numeric
    }
  }
}
```

## 6. Data Dictionary

```{r data-dictionary}
data_dict <- tibble(
  column = names(df),
  type = map_chr(df, ~ class(.x)[1]),
  pct_missing = map_dbl(df, ~ round(100 * sum(is.na(.x)) / length(.x), 1)),
  example = map_chr(df, ~ {
    non_na <- .x[!is.na(.x)]
    if (length(non_na) > 0) as.character(non_na[1]) else "NA"
  })
)

knitr::kable(data_dict, caption = "Data Dictionary")
```

## 7. Propagate Player-Level Covariates

```{r propagate-covariates}
# Keywords for player-level covariates
player_covariate_keywords <- c("height", "mass", "weight", "body", "position", "group", "age")

# Identify candidate columns by keyword
keyword_matches <- names(df)
covariate_candidates <- character(0)

for (kw in player_covariate_keywords) {
  matches <- keyword_matches[str_detect(tolower(keyword_matches), tolower(kw))]
  covariate_candidates <- c(covariate_candidates, matches)
}
covariate_candidates <- unique(covariate_candidates)

# Also check missingness pattern
if ("player_id" %in% names(df)) {
  missingness_check <- df %>%
    group_by(player_id) %>%
    summarise(across(everything(), ~ sum(is.na(.x)) / n()), .groups = "drop") %>%
    select(-player_id)

  avg_missing <- colMeans(missingness_check, na.rm = TRUE)
  pattern_candidates <- names(avg_missing)[avg_missing > 0.5 & avg_missing < 1]

  covariate_candidates <- unique(c(covariate_candidates, pattern_candidates))
}

# Remove key columns from propagation
covariate_candidates <- setdiff(covariate_candidates, c("player_id", "shot_type", "made", "shot_number"))

cat("Columns identified for propagation:", paste(covariate_candidates, collapse = ", "), "\n")
```

```{r fill-covariates}
# Fill report
fill_report <- tibble(
  column = character(),
  na_before = integer(),
  na_after = integer(),
  rows_changed = integer()
)

if (length(covariate_candidates) > 0 && "player_id" %in% names(df)) {
  for (col in covariate_candidates) {
    if (col %in% names(df)) {
      na_before <- sum(is.na(df[[col]]))
      original_values <- df[[col]]

      df <- df %>%
        group_by(player_id) %>%
        tidyr::fill(!!sym(col), .direction = "downup") %>%
        ungroup()

      na_after <- sum(is.na(df[[col]]))
      rows_changed <- sum(is.na(original_values) & !is.na(df[[col]]))

      fill_report <- fill_report %>%
        add_row(
          column = col,
          na_before = na_before,
          na_after = na_after,
          rows_changed = rows_changed
        )
    }
  }

  knitr::kable(fill_report, caption = "Fill Report: Player-Level Covariate Propagation")
} else {
  cat("No columns to propagate or player_id not found.\n")
}
```

## 8. Save Cleaned Data

```{r save-data}
# Create output directory if it doesn't exist
output_dir <- file.path(repo_root, "data")
if (!dir.exists(output_dir)) {
  dir.create(output_dir, recursive = TRUE)
  cat("Created directory:", output_dir, "\n")
}

# Output file path
output_file <- file.path(output_dir, "grf_shooting_clean.csv")

# Write the cleaned data
write_csv(df, output_file)
cat("Saved cleaned data to:", output_file, "\n")
```

## 9. Final Summary

```{r final-summary}
cat("========================================\n")
cat("FINAL SUMMARY\n")
cat("========================================\n")
cat("Final dimensions:", nrow(df), "rows x", ncol(df), "cols\n\n")
```

### Trials per Player

```{r trials-per-player}
if ("player_id" %in% names(df)) {
  trials_per_player <- df %>%
    count(player_id, name = "n_trials")

  knitr::kable(trials_per_player, caption = "Trials per Player")
}
```

### Trials by Shot Type

```{r trials-by-shot-type}
if ("player_id" %in% names(df) && "shot_type" %in% names(df)) {
  shot_breakdown <- df %>%
    count(player_id, shot_type) %>%
    pivot_wider(names_from = shot_type, values_from = n, values_fill = 0)

  knitr::kable(shot_breakdown, caption = "Trials per Player by Shot Type")

  # Check completeness
  expected_2pt <- 10
  expected_3pt <- 10
  complete_players <- shot_breakdown %>%
    filter(`2PT` == expected_2pt & `3PT` == expected_3pt) %>%
    nrow()

  cat("\nPlayers with complete data (10 2PT + 10 3PT):", complete_players, "of",
      n_distinct(df$player_id), "\n")
}
```

## Session Info

```{r session-info}
sessionInfo()
```
